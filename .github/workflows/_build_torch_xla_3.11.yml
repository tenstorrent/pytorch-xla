name: build-torch-xla
on:
  workflow_call:
    inputs:
      torch_version:
        description: 'Torch version to build (default: 2.7.0)'
        required: false
        type: string
        default: '2.7.0'
      xla_branch:
        description: 'PyTorch-XLA branch to build (default: master)'
        required: false
        type: string
        default: 'master'
    outputs:
      artifact_name:
        description: 'Name of uploaded wheels artifact'
        value: ${{ jobs.build-wheels.outputs.artifact_name }}
  workflow_dispatch:
    inputs:
      torch_version:
        description: 'Torch version to build (default: 2.7.0)'
        required: false
        type: string
        default: '2.7.0'
      xla_branch:
        description: 'PyTorch-XLA branch to build (default: master)'
        required: false
        type: string
        default: 'master'
jobs:
  build-wheels:
    runs-on: ubuntu-latest
    timeout-minutes: 540
    env:
      ARTIFACT_NAME: install-artifact-torch-xla-release
      GIT_VERSIONED_XLA_BUILD: 1
    container:
      image: us-central1-docker.pkg.dev/tpu-pytorch-releases/docker/development:tpu
      options: --user root
    outputs:
      artifact_name: ${{ steps.set_upload_name.outputs.artifact_name }}
    steps:
      - name: Maximize space
        shell: bash
        run: |
          # tenstorrent/tt-github-actions/.github/actions/maximize_space@main without sudo         
          echo "Disk usage before"
          echo "========================"
          df -h
          echo "Space used by toolchain"
          echo "-------------------------"
          du -h --max-depth=2 /opt || true
          echo "Space used by sw packages"
          echo "-------------------------"
          du -h --max-depth=2 /__t || true
          # Remove sw packages
          if [ -d "/__t" ]; then
            rm -fr /__t/PyPy || true
            rm -fr /__t/node || true
            rm -fr /__t/CodeQL || true
            rm -fr /__t/Ruby || true
            rm -fr /__t/go || true
            rm -fr /__t/Python || true
          fi
          if [ -d "/opt/hostedtoolcache" ]; then
            rm -fr /opt/hostedtoolcache/PyPy || true
            rm -fr /opt/hostedtoolcache/node || true
            rm -fr /opt/hostedtoolcache/CodeQL || true
            rm -fr /opt/hostedtoolcache/Ruby || true
            rm -fr /opt/hostedtoolcache/go || true
            rm -fr /opt/google/chrome || true
            rm -fr /opt/microsoft || true
            rm -fr /opt/az || true
          fi
          echo "Disk usage after"
          echo "========================"
          df -h
      - name: "Build Torch/XLA wheel"
        shell: bash
        id: build_wheels
        run: |
          cmake --version
          apt-get update && apt-get install -y curl git build-essential

          # Clean up any existing pyenv installation
          rm -rf $HOME/.pyenv

          curl https://pyenv.run | bash
          export PATH="$HOME/.pyenv/bin:$PATH"
          eval "$(pyenv init -)"
          pyenv install 3.11
          pyenv global 3.11
          ln -sf $(pyenv which python3.11) /usr/local/bin/python3.11

          # Install essential packages for Python 3.11
          python3.11 -m pip install --upgrade pip
          python3.11 -m pip install pyyaml setuptools wheel numpy typing_extensions requests

          cd /tmp
          git clone --recursive --branch v${{ inputs.torch_version || '2.7.0' }} https://github.com/pytorch/pytorch.git
          cd pytorch/
          git clone --recursive --branch ${{ inputs.xla_branch || 'master' }} https://github.com/tenstorrent/pytorch-xla.git xla


          (
            # Build PyTorch
            # From https://docs.pytorch.org/FBGEMM/fbgemm/development/BuildInstructions.html, section "Build Issues with GCC 12+"
            export CFLAGS+="-w -Wno-error=maybe-uninitialized -Wno-error=uninitialized -Wno-error=restrict"
            export CXXFLAGS+="-w -Wno-error=maybe-uninitialized -Wno-error=uninitialized -Wno-error=restrict"
            # copy pre-built wheels from cache
            MAX_JOBS=8 BAZEL_JOBS=8 python3.11 setup.py bdist_wheel
            MAX_JOBS=8 BAZEL_JOBS=8 python3.11 setup.py develop
          )

          # Build PyTorch/XLA
          cd xla/
          MAX_JOBS=8 BAZEL_JOBS=8 python3.11 setup.py bdist_wheel

          # Collect wheels
          mkdir -p /dist
          cp dist/*.whl /dist/

          # Clean up any existing pyenv installation
          rm -rf $HOME/.pyenv

      - name: "Upload Wheels Artifact"
        id: upload
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: /dist/*.whl
      
      - name: Set artifact name output
        id: set_upload_name
        run: echo "artifact_name=${{ env.ARTIFACT_NAME }}" >> $GITHUB_OUTPUT
